import { isAddress as n } from "viem";
import { getCurrentUserSync as f } from "./index.web10.js";
import { toTransactionSigner as a } from "./index.web42.js";
import { toViemAccount as c } from "./index.web22.js";
function g(e = {}) {
  const s = e.fetch ?? globalThis.fetch;
  let r = null;
  return { fetchWithPayment: async (...o) => {
    if (!r) {
      const t = f();
      if (!t)
        throw new Error("User not authenticated");
      const u = (() => {
        if (e.address && n(e.address))
          return c(e.address);
        if (e.address && !n(e.address))
          return a(e.address);
        if (t.evmSmartAccounts?.length)
          return c(t.evmSmartAccounts[0]);
        if (t.evmAccounts?.length)
          return c(t.evmAccounts[0]);
        if (t.solanaAccounts?.length)
          return a(t.solanaAccounts[0]);
        throw new Error("No account found");
      })();
      try {
        const { wrapFetchWithPayment: h } = await import("x402-fetch");
        r = h(
          s,
          u,
          e.maxValue,
          e.paymentRequirementsSelector,
          e.config
        );
      } catch {
        throw new Error(
          "x402-fetch is not installed. Make sure x402-fetch is installed and try again."
        );
      }
    }
    return r(...o);
  } };
}
export {
  g as fetchWithX402
};
